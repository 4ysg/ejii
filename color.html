<script>
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const thicknessSlider = document.getElementById('thicknessSlider');
        const opacitySlider = document.getElementById('opacitySlider');
        const exportButton = document.getElementById('exportButton');
        const importInput = document.getElementById('importInput');
        const eraserButton = document.getElementById('eraserButton');
        let isDrawing = false;
        let isErasing = false;

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;

            ctx.lineWidth = thicknessSlider.value;
            if (isErasing) {
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = $('#colorPicker').spectrum('get').toHexString();
            }
            ctx.globalAlpha = opacitySlider.value;

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function changeThickness() {
            ctx.lineWidth = thicknessSlider.value;
        }

        function changeOpacity() {
            ctx.globalAlpha = opacitySlider.value;
        }

        function exportDrawing() {
            const fileName = prompt('Enter a filename');
            if (!fileName) return;

            const prefix = fileName.replace(/\.[^/.]+$/, '');
            const suffix = ".e7446dshwjsuauwzsduyauw";
            const dataURL = canvas.toDataURL();
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = prefix + suffix;
            a.click();
        }

        function importDrawing() {
            const file = importInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleEraser() {
            isErasing = !isErasing;
            eraserButton.classList.toggle('active', isErasing);
        }

        function updateCursor(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            document.getElementById('drawingCanvas').style.cursor = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23${$('#colorPicker').spectrum('get').toHex()}" viewBox="0 0 16 16"><circle cx="8" cy="8" r="${thicknessSlider.value / 2}" /></svg>') ${x} ${y}, auto`;
        }

        exportButton.addEventListener('click', exportDrawing);
        importInput.addEventListener('change', importDrawing);

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        eraserButton.addEventListener('click', toggleEraser);

        $('#colorPicker').spectrum({
            type: "color",
            showPalette: false,
            showButtons: false,
            showInput: true,
            preferredFormat: "hex"
        });
    });
</script>
